sensor:
  - platform: template
    sensors:
      humidity_whole_house:
        friendly_name: Whole House Humidity
        unit_of_measurement: '%'
        value_template: >-
          {% set humidity = namespace(sum=0, count=0) %}
          {% for sensor in [
              'sensor.4_in_1_multisensor_humidity',
              'sensor.multisensor_6_humidity'
            ] %}
            {% if states(sensor)|float > 0 %}
              {% set humidity.sum = humidity.sum + (states(sensor)|float) %}
              {% set humidity.count = humidity.count + 1 %}
            {% endif %}
          {% endfor %}
          {% if humidity.count == 0 %}
            {% set humidity.count = 1 %}
          {% endif %}
          {{ (humidity.sum / humidity.count)|round(1) }}

automation:
  - alias: Thermostat Lower Humidity
    id: 982c767a-929c-40d3-a648-b7da87f2aa4a
    trigger:
      - platform: time_pattern
        minutes: "/5"
    condition:
      - alias: "Cooling has not been on"
        condition: state
        entity_id: binary_sensor.hvac_cooling
        state: "off"
        for:
          minutes: 26
      - alias: "Humidity is high"
        condition: numeric_state
        entity_id: sensor.node_34_humidity
        above: 60
    action:
      - alias: "Run humidity lower script"
        service: script.humidity_lower_with_ac
    
  - alias: Dehumidifier not running
    id: 6961b571-902f-408e-8641-8e1c96e6dad9
    trigger:
      - platform: numeric_state
        entity_id: sensor.smart_energy_switch_power_2
        below: 50
        for: "00:30:00"
    condition:
      - alias: "Crawl space humidity is high"
        condition: numeric_state
        entity_id: sensor.temperature_humidity_xs_sensor_humidity_2
        above: 50
    action:
      - alias: "Notify michael"
        service: script.notify_michael
        data:
          title: Taliluna Alert
          message: "Check dehumidifer. Power is {{states('sensor.smart_energy_switch_power_2')}} W"
          alert_level: Debug|Info|Warn

script:
  humidity_lower_with_ac:
    alias: "Humidity Lower with AC"
    variables:
      ac_setpoint: >-
        {{state_attr('climate.node_34', 'temperature') or state_attr('climate.node_34', 'target_temp_high')}}
      current_temp: "{{state_attr('climate.node_34', 'current_temperature')}}"
      new_setpoint: "{{ current_temp|int - 1}}"
    sequence:
      - if:
          - "{{ac_setpoint|int < current_temp|int}}"
        then:
          - stop: "Temperature is already lower than setpoint"
      - alias: "Set thermostat to current temp or below"
        choose:
        - conditions:
            - "{{states('climate.node_34') == 'heat_cool'}}"
          sequence:
            - alias: "Set thermostat back to original temperature"
              service: climate.set_temperature
              target:
                entity_id: climate.node_34
              data:
                target_temp_high: "{{new_setpoint}}"
        - conditions:
            - "{{states('climate.node_34') == 'cool'}}"
          sequence:
            - alias: "Set thermostat back to original temperature"
              service: climate.set_temperature
              target:
                entity_id: climate.node_34
              data:
                temperature: "{{new_setpoint}}"
      - alias: "Wait 10 minutes or until the thermostat is adjusted elsewhere"
        wait_for_trigger:
          - platform: state
            entity_id: climate.node_34
            to: "heat"
          - platform: state
            entity_id: climate.node_34
            to: "off"
          - platform: state
            entity_id: climate.node_34
            attribute: temperature
            for: "00:00:05"
          - platform: state
            entity_id: climate.node_34
            attribute: target_temp_high
            for: "00:00:05"
        timeout:
          minutes: 10
      - if: 
        - "{{not wait.trigger}}"
        then:
          - alias: "Set thermostat back depending on mode"
            choose:
            - conditions:
                - "{{states('climate.node_34') == 'heat_cool'}}"
              sequence:
                - alias: "Set thermostat back to original temperature"
                  service: climate.set_temperature
                  target:
                    entity_id: climate.node_34
                  data:
                    target_temp_high: "{{ac_setpoint}}"
            - conditions:
                - "{{states('climate.node_34') == 'cool'}}"
              sequence:
                - alias: "Set thermostat back to original temperature"
                  service: climate.set_temperature
                  target:
                    entity_id: climate.node_34
                  data:
                    temperature: "{{ac_setpoint}}"
