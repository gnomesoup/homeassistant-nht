group:
  temperature_sensors:
    name: Temperature Sensors
    entities:
      - sensor.dsb05_multisensor_air_temperature
      - sensor.smartthings_moisture_temperature
      - sensor.multisensor_6_air_temperature
      - sensor.4_in_1_multisensor_air_temperature
      - sensor.z_wave_plus_thermostat_air_temperature

input_datetime:
  thermostat_time_day:
    name: Thermostat Time Day
    has_date: false
    has_time: true
  thermostat_time_weekend_day:
    name: Thermostat Time Weekend Day
    has_date: false
    has_time: true
  thermostat_time_night:
    name: Thermostat Time Night
    has_date: false
    has_time: true

input_number:
  thermostat_setpoint_cool_day:
    name: Thermostat Setpoint Cool Day
    icon: mdi:thermostat
    min: 65
    max: 80
    mode: box
  thermostat_setpoint_cool_night:
    name: Thermostat Setpoint Cool Night
    icon: mdi:thermostat
    min: 65
    max: 80
    mode: box
  thermostat_setpoint_cool_away:
    name: Thermostat Setpoint Cool Away
    icon: mdi:thermostat
    min: 65
    max: 80
    mode: box
  thermostat_setpoint_heat_day:
    name: Thermostat Setpoint Heat Day
    icon: mdi:thermostat
    min: 50
    max: 80
    mode: box
  thermostat_setpoint_heat_night:
    name: Thermostat Setpoint Heat Night
    icon: mdi:thermostat
    min: 50
    max: 80
    mode: box
  thermostat_setpoint_heat_away:
    name: Thermostat Setpoint Heat Away
    icon: mdi:thermostat
    min: 50
    max: 80
    mode: box

sensor:
  - platform: template
    sensors:
      temperature_whole_house:
        friendly_name: Whole House Temperature
        unit_of_measurement: 'Â°F'
        value_template: >-
          {% set temp = namespace(sum=0, count=0) %}
          {% for sensor in [
              'sensor.smartthings_moisture_temperature',
              'sensor.multisensor_6_air_temperature',
              'sensor.4_in_1_multisensor_air_temperature',
              'sensor.z_wave_plus_thermostat_air_temperature'
            ] %}
            {% if states(sensor)|float > 0 %}
              {% set temp.sum = temp.sum + (states(sensor)|float) %}
              {% set temp.count = temp.count + 1 %}
            {% endif %}
          {% endfor %}
          {% if temp.count == 0 %}
            {% set temp.count = 1 %}
          {% endif %}
          {{ (temp.sum / temp.count)|round(1) }}

automation:
  - id: eac65317-2910-4553-811a-92795aaa6cc7
    alias: Set Thermostat Night
    trigger:
      - platform: time
        at: input_datetime.thermostat_time_night
    condition:
      - condition: not
        conditions:
          - alias: "Alarm is not away"
            condition: state
            entity_id: alarm_control_panel.home_alarm
            state: "armed_away"
      - alias: "Not in guest mode"
        condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
    action:
      - alias: "Heat or cool"
        choose:
        - conditions:
            - alias: "Heat is on"
              condition: state
              entity_id: climate.z_wave_plus_thermostat
              state: "heat"
          sequence:
            - alias: "Set thremostat setpoint"
              service: climate.set_temperature
              target:
                entity_id: climate.z_wave_plus_thermostat
              data:
                temperature: "{{ states('input_number.thermostat_setpoint_heat_night')}}"
            - alias: "Set fan"
              service: climate.set_fan_mode
              target:
                entity_id: climate.z_wave_plus_thermostat
              data:
                fan_mode: "Low"
        default:
          - alias: "Set thremostat setpoint"
            service: climate.set_temperature
            target:
              entity_id: climate.z_wave_plus_thermostat
            data:
              temperature: "{{states('input_number.thermostat_setpoint_cool_night')}}"
          - alias: "Set fan"
            service: climate.set_fan_mode
            target:
              entity_id: climate.z_wave_plus_thermostat
            data:
              fan_mode: "Low"

  - id: 1dd4b108-62d8-4a37-bc79-db7401a53565
    alias: Set Thermostat Workday
    trigger:
      - platform: time
        at: input_datetime.thermostat_time_day
    condition:
      - condition: not
        conditions:
          - alias: "Alarm is not away"
            condition: state
            entity_id: alarm_control_panel.home_alarm
            state: "armed_away"
      - alias: "Not in guest mode"
        condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
      - alias: "Is a workday"
        condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
    action:
      - alias: "Heat or cool"
        choose:
        - conditions:
            - alias: "Heat is on"
              condition: state
              entity_id: climate.z_wave_plus_thermostat
              state: "heat"
          sequence:
            - alias: "Set thremostat setpoint"
              service: climate.set_temperature
              target:
                entity_id: climate.z_wave_plus_thermostat
              data:
                temperature: "{{ states('input_number.thermostat_setpoint_heat_day')}}"
            - alias: "Set fan"
              service: climate.set_fan_mode
              target:
                entity_id: climate.z_wave_plus_thermostat
              data:
                fan_mode: "Low"
        default:
          - alias: "Set thremostat setpoint"
            service: climate.set_temperature
            target:
              entity_id: climate.z_wave_plus_thermostat
            data:
              temperature: "{{states('input_number.thermostat_setpoint_cool_day')}}"
          - alias: "Set fan"
            service: climate.set_fan_mode
            target:
              entity_id: climate.z_wave_plus_thermostat
            data:
              fan_mode: "Low"

  - id: f4b02269-3f4b-48df-9748-f5dc3399fd46
    alias: Set Thermostat Non Workday
    trigger:
      - platform: time
        at: input_datetime.thermostat_time_weekend_day
    condition:
      - condition: not
        conditions:
          - alias: "Alarm is not away"
            condition: state
            entity_id: alarm_control_panel.home_alarm
            state: "armed_away"
      - alias: "Not in guest mode"
        condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
      - alias: "Is a workday"
        condition: state
        entity_id: binary_sensor.workday_sensor
        state: "off"
    action:
      - alias: "Heat or cool"
        choose:
        - conditions:
            - alias: "Heat is on"
              condition: state
              entity_id: climate.z_wave_plus_thermostat
              state: "heat"
          sequence:
            - alias: "Set thremostat setpoint"
              service: climate.set_temperature
              target:
                entity_id: climate.z_wave_plus_thermostat
              data:
                temperature: "{{ states('input_number.thermostat_setpoint_heat_day')}}"
            - alias: "Set fan"
              service: climate.set_fan_mode
              target:
                entity_id: climate.z_wave_plus_thermostat
              data:
                fan_mode: "Low"
        default:
          - alias: "Set thremostat setpoint"
            service: climate.set_temperature
            target:
              entity_id: climate.z_wave_plus_thermostat
            data:
              temperature: "{{states('input_number.thermostat_setpoint_cool_day')}}"
          - alias: "Set fan"
            service: climate.set_fan_mode
            target:
              entity_id: climate.z_wave_plus_thermostat
            data:
              fan_mode: "Low"